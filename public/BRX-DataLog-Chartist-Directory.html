<!DOCTYPE html>
<html>
<meta charset="UTF-8">	
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
#brxProgress {
  width: 100%;
  background-color: white;
}

#brxBar {
  width: 0%;
  height: 100%;
  background-color: #0A77BB;
}
.ct-zoom-rect {
      fill: rgba(200, 100, 100, 0.3);
      stroke: red;
    }
.fixed {
      position:fixed;
}
.ct-point {
      stroke-width: 20px;
      stroke-linecap: round;
}
table {
  font-family: Arial, Helvetica, sans-serif;
  font-size: 12px;
  border-collapse: collapse;
  width: 100%;
}

th {
  border: 1px solid #dddddd;
  background-image: linear-gradient(grey, white);
  text-align: left;
  padding: 0px;
}

tr:nth-child(even) {
  background-color: white;
  padding: 0px;
  
}
tr:nth-child(odd) {
  background-color: #dddddd;
  padding: 2px;
}
body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
}
p {
  border: 2px solid powderblue;
  padding: 0px;
}
.topnav {
  overflow: hidden;
  background-color: #333;
}

.topnav a {
  float: left;
  display: block;
  color: #f2f2f2;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
  font-size: 17px;
}
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: Arial;
}

.header {
  text-align: center;
  padding: 32px;
}

.row {
  display: -ms-flexbox; /* IE10 */
  display: flex;
  -ms-flex-wrap: wrap; /* IE10 */
  flex-wrap: wrap;
  padding: 0 4px;
}

/* Create four equal columns that sits next to each other */
.column {
  -ms-flex: 25%; /* IE10 */
  flex: 25%;
  max-width: 25%;
  padding: 0 4px;
}

.column img {
  margin-top: 8px;
  vertical-align: middle;
  width: 25%;
}

.topnav a:hover {
  background-color: #ddd;
  color: black;
}

.topnav a.active {
  background-color: #0A77BB;
  color: white;
}

.topnav .icon {
  display: none;
}


@media screen and (max-width: 600px) {
  .topnav a:not(:first-child) {display: none;}
  .topnav a.icon {
    float: right;
    display: block;
  }
}
@media screen and (max-width: 800px) {
  .column {
    -ms-flex: 25%;
    flex: 25%;
    max-width: 25%;
  }
}

/* Responsive layout - makes the two columns stack on top of each other instead of next to each other */
@media screen and (max-width: 600px) {
  .column {
    -ms-flex: 100%;
    flex: 100%;
    max-width: 100%;
  }

@media screen and (max-width: 600px) {
  .topnav.responsive {position: relative;}
  .topnav.responsive .icon {
    position: absolute;
    right: 0;
    top: 0;
  }
  .topnav.responsive a {
    float: none;
    display: block;
    text-align: left;
  }
}
</style>

<head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.4/chartist.min.css" integrity="sha512-V0+DPzYyLzIiMiWCg3nNdY+NyIiK9bED/T1xNBj08CaIUyK3sXRpB26OUCIzujMevxY9TRJFHQIxTwgzb0jVLg==" crossorigin="anonymous" />
  <!--   
  Using CDN served files where can as a best practice, otherwise could be put on /sd folder tree
    <link rel="stylesheet" href="/sd/css/chartist.min.css">
    <script src="/sd/js/moment.min.js"></script>
    <script src="/sd/js/chartist.min.js"></script>
  -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.4/chartist.min.js" integrity="sha512-9rxMbTkN9JcgG5euudGbdIbhFZ7KGyAuVomdQDI9qXfPply9BJh0iqA7E/moLCatH2JD4xBGHwV6ezBkCpnjRQ==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous"></script>
  <script src="/sd/js/chartist-plugin-zoom.min.js"></script>

</head>
<body>
<div class="topnav" id="myTopnav">
  <a href="/ninf" style= "padding: 10px 5px;">
	<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAAZCAYAAACB6CjhAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFTElEQVRYhd2YW2xUVRSGvzUzFFpKkaCUAoqKeAkQJT4IaiIxAQVNJF5iEI0SxHAxGgQ1KC8m4gsEkSjGCBrqpRAFQkwplxgUEKMSWlFAEsDIpVAoobaUcmnn9+FM28OZvWemrYmJf3Ie9lpr/2vttfdZ+2L8jyCpP7AAsJA4D7gAzDKzi/9JYB2FJMtu5ey3QW4slxR39Uk4SJYC1+bg7yLQBBwDdppZRYhjIvBsDhyXCWbnDLAf2GRmfwF5kspS8pNApZmtzUQkaQkw3qH60Mxm5hALSOrlyWAu2CdpSIqnvAs876U4tkfkv2WIe7qHa2tOAw8R3d2FwCWpOsWzo4s8L6R4oljuiHmsh+OgOvoryZ/JjuBxSZVdJUnFs86hGhyK90ZJutSilupGNYZsLkkqzmXM0Row3GGzBfg2IisCJgE3OOzHAQMc8gVAQ6gdA4YBk12BSeoGvARMjKgWA4+l9D8BxAybt4sDRc3o3TGUnI8xosjsjIs3IyRtdmR8jMc2Jqk+YtsoaaWD42gGn3M9i6BfSr/PobtekTrzzREd52WVXbdaXxevkmsinYhF2sMcNqddHc0syZX7LcABj723gJGaxQhqCXYAgHkO/UFgQlgwbiD9ikdRcuQk+TUNLC5cqQWFpUESM6EtAZIGkb50T5vZXldHSR8BhRHxcoKtMQonRwrTHbJVZtYCYGbrgZqIPm1Pb0myNJlkOwV069WdhBmjDcoKS/VEBt/tMyhpAlAe0f8NbOPKWhEnqBXRZJWb2cOS9gAjIrpnzOzzsEBSCTANeMsRVx8zqwvZzgCWZRjHbjO7k4V6qLCYOWml3zikOEvOPZU+meEEzAPeyeDEhxPAXDP7UtLVuH+BE0BLqB0HShx2AsaY2bY0hXQYd9GtBQab2XkWanjvYpYmPYGasba+Lx8zof1IHK4Bt3r6ZUOC9sG4qj8p/aDQFx28gBXAAM/gu3l4jwIjzew8AK/a70k46wtU4tFetawuLNX94eBbcbOvYxZcAyyS1Jfgd+ks6s3spEe3B/fsnzOzY22tFRpgUKDMfooM5heV6l7ilCUAJCVwnwEmESzfMPoAM4GxEflrwCOZfXthwGxJmNkrYYWkcvyr8zZJk83sC4CY8bygexZfh2VUxFqoyutBjaWcjCDIchg1ZtbfxyLpBODVh/AJ8EGonQBGAYuA6NL+1czuCPlYDMzOwn/QzIayTH3i+XxVEE/b2jEjKdgSb2ZT3RSrCutaf4Fo1Yb0hESRZaW1YZ2Z7Y7IfpY0FHgxIm87KUqaSvbBA9y095T6D1vPXdHqb1CNUR5rpqJuSvuuEkamBGzyeZQ0BXcVd+GQRx7d2wGOp/jvIzhTRFEJzAJ2hoWJPCpo4E+uCnY1M77H2FD/tP2SLbjWBLgKYImkB0LtOEHBu4dg/46iAcjnysJaR3A6dGGIQ7ZGwQ3uO4cuCYw3sxpJmwnuHLQIlR4ijyT1zWdZ21DAZmbYKY/PdEjqLmm/5zyeK6okvS4pGZHvyOB3Z8S2RdKTkrZ6fIwO9b2lVdjUrMu7alVbe0Hv5zzoSCAjU847iyZJxZLecOg+9fiMSaqO2DZLuuDx8ZyDw3VVHtiZBMzp5MAlaZOCOwSSLjr0b3p89u6Aj7c9HPmSTkdsN3Z0/AmCt70fcrBtBhoJjp5/ABvNrDIVTE/gR9LfF7Z4uJqADUBvgnPGg6RfrADWmNl8F4GZNSl4gpsK3A4UAz0k9TSzxhzG8+9BnXzFTfWd5pn5quy9nXzO118f0l6FOwMzy/VM4MIQ4DOCFdYK0bmLGa3X6FzxD4YDMiC3hrnNAAAAAElFTkSuQmCC"/>
  </a>
  <a href="BRX-Linear-Gauge-JSON-Request.html" >Linear Gauges</a>
  <a href="BRX-Radial-Gauge-JSON-Request.html">Radial Gauge</a>
  <a href="BRX-DataLog-Chartist-Legend.html" >Live Trend</a>
  <a href="BRX-DataLog-Chartist-Directory.html" class="active">Log Trend</a>
  <a href="javascript:void(0);" class="icon" onclick="myFunction()" style= "padding: 10px 13px;">
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAApCAYAAAB3LnrpAAABEUlEQVRoQ2NkGCaAEeSP81dvf2BjY2Mbin769evXL0NtVQGwR67dffxzKHtES1mWfdQjgyUZgpIWPEau3338k3WI5pHfv3790oQlrVGPDIL0hRIjw6bUCggKns/IyMgyCAKYZCf8////z4Z1axPBxe9wAKMeGWyxOBojgzVGhnrM/B9tNA6WpIXSaBw2Nftoo3EQpK/h2YwfNnlk2HhEXFxcbBAkd7Kd8PLly1dDvUaHe37UI2SnAxppHI0RGgUs2cYOrxg5fvbyDzY2Nnayg2MANf769eunpbEux/Dqj4y2fgcwScGsHm39DoJIQHHC8OzqDptmfFRMYiYzMyPTYEs2xLjn79///5YtmT992NTsAJIK1Sr6h6CQAAAAAElFTkSuQmCC" height="25" />
  </a>
</div>

<div style="padding:10px">


<div class="row" id="id01"> 
	<div class="column">
	    <label for="logfiles">Select Log File:</label>
		<select id="logfiles" name="logfiles" >
		</select>
		<button type="button" onclick="parseCSV()" class="btn btn-success btn-sm m-b-10 m-l-5">Load</button>
	</div>
	<div class="column" id="brxProgress">
		<div id="brxBar"></div>
	</div>	
	<div class="column">
		<button type="button" id="resetZ" class="btn btn-success btn-sm m-b-10 m-l-5">Reset Zoom</button>
	</div>
		

</div>
<div class="row" id="id02"> 



</div>
<div class="row"> 

<div class="column">
<div class="ct-chart ct-major-tenth"></div>

</div>

</div>
<div class="row"> 
<table id="tLegend">
  <tr>
	<th width=21px></th>
    <th width=250px>Element</th>
    <th width=120px>Last Value</th>
    <th >Avg</th>
	<th>Min</th>
	<th>Max</th>
	<th width=250px>Interpolation</th>
  </tr>
</table>
</div>



<script>


function myFunction() {
  var x = document.getElementById("myTopnav");
  if (x.className === "topnav") {
    x.className += " responsive";
  } else {
    x.className = "topnav";
  }
}
var tags = []
var xmlhttp = new XMLHttpRequest();
var csvhttp = new XMLHttpRequest();

update();
function update()
	{
		
		xmlhttp.open("GET", "../../data/json?SDFileNames=SDFileNames0,25", true);

		xmlhttp.send();
	};
	
function parseCSV()
	{
		var selValue = document.getElementById("logfiles").value
		var Parent = document.getElementById("tLegend");
		var pBar = document.getElementById("brxBar")
		

		pBar.innerHTML= "Downloading"
		while(Parent.rows.length>1)
		{
		   Parent.deleteRow(-1);
		}

		trdData = JSON.parse('{"series": []}');
		if(selValue.includes(".csv")){
			csvhttp.onprogress = updateProgress;
			csvhttp.open("GET", "../../sd/logs/" + selValue, true);

			csvhttp.send();
		}
	};

csvhttp.onreadystatechange = function() {
  var pBar = document.getElementById("brxBar")
  if (this.readyState == 4 && this.status == 200) {
	  var lines=this.responseText.split("\n");
	  var headers=lines[0].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
	  var tbl = document.getElementById("tLegend");
	  var colors =["DarkRed", "Salmon","Gold", "GoldenRod", "Black", "Green", "Blue", "RebeccaPurple","LightPink","SandyBrown", "PaleGoldenRod","Grey","YellowGreen","CornflowerBlue","MediumPurple"]
	  tags=[]
	  
	  pBar.innerHTML= "Loading"
	  for(var i=1;i<headers.length && i<15;i++){
			tags.push({tag: headers[i].replaceAll('"',''), avg:0, min:null, max:null,total:0,count:0,pos:i});
			var table = document.getElementById("tLegend");
			var row = table.insertRow(-1);
			var cell1 = row.insertCell(0);
			var cell2 = row.insertCell(1);
			var cell3 = row.insertCell(2);
			var cell4 = row.insertCell(3);
			var cell5 = row.insertCell(4);
			var cell6 = row.insertCell(5);
			var cell7 = row.insertCell(6);
			cell2.innerHTML = headers[i].replaceAll('"','')
			cell2.style.color=colors[i-1]
			cell2.style.fontWeight = 'bold'
			cell7.innerHTML =  '<form id= "interp-' + headers[i].replaceAll('"','')+ '" onchange="updateInterp(\''+ headers[i].replaceAll('"','') + '\')">  <input type="radio" name = "ans" > None <input type="radio" name = "ans" checked> Simple <input type="radio" name = "ans" > Step </form>'

			trdData.series.push({name: headers[i].replaceAll('"',''),
			data: []})
		
	  }
		for(var i=1;i<lines.length-1;i++){
			for (tag of tags){
				lValues = lines[i].split(",");
				trdData.series[tag.pos-1].data.push({x: Date.parse(lValues[0]), y: lValues[tag.pos]})
				tag.count = tag.count +1
				tag.total = tag.total + Number(lValues[tag.pos])
				tbl.rows[tag.pos].cells[2].innerHTML=lValues[tag.pos]
				tbl.rows[tag.pos].cells[3].innerHTML=(tag.total/tag.count).toFixed(4)
				if(Number(lValues[tag.pos]) <tag.min || tag.count ==1){
					tag.min = Number(lValues[tag.pos])
				}
				tbl.rows[tag.pos].cells[4].innerHTML=tag.min
			  if( Number(lValues[tag.pos])>tag.max  || tag.count ==1){
			  tag.max =  Number(lValues[tag.pos])
			  }
			   tbl.rows[tag.pos].cells[5].innerHTML=tag.max
			}
			}
			chart.update(trdData)
			pBar.style.width = 0 + "%"
			pBar.innerHTML= ""
	} 
	if(this.readyState == 4 && this.status != 200){
		
		pBar.innerHTML= "Load Fail"
	}
  }
function updateInterp(seriesN) {
	var interp = document.getElementById("interp-"+ seriesN.replaceAll('"',''))
	var option 
	var obj ;	
	if(interp[0].checked==true){
		option={axisX: {
		type: Chartist.FixedScaleAxis,
			divisor: 6,
			labelInterpolationFnc: function(value) {
				return moment(value).format('MMM D yyyy hh:mm:ss');
			}
			},series:{ [seriesN]:{lineSmooth: Chartist.Interpolation.none({fillHoles: false})}}}
		chart.update(trdData,option,true)
	}
	if(interp[1].checked==true){
		option={axisX: {
		type: Chartist.FixedScaleAxis,
			divisor: 6,
			labelInterpolationFnc: function(value) {
				return moment(value).format('MMM D yyyy hh:mm:ss');
			}
			},series:{ [seriesN]:{lineSmooth: Chartist.Interpolation.simple({fillHoles: false})}}}
		chart.update(trdData,option,true)		
	}
		if(interp[2].checked==true){
		option={axisX: {
		type: Chartist.FixedScaleAxis,
			divisor: 6,
			labelInterpolationFnc: function(value) {
				return moment(value).format('MMM D yyyy hh:mm:ss');
			}
			},series:{ [seriesN]:{lineSmooth: Chartist.Interpolation.step({fillHoles: false})}}}
		chart.update(trdData,option,true)
	}




}
	
xmlhttp.onreadystatechange = function() {
  if (this.readyState == 4 && this.status == 200) {
	  //document.getElementById("id02").innerHTML= this.responseText;
	    var values = JSON.parse(this.responseText)
		var x = document.getElementById("logfiles");
		var option = document.createElement("option");

		
		

		for (filN of values.SDFileNames) {
			if (filN !="" && filN.includes(".csv")){
				var option = document.createElement("option");
				option.text = filN;
				option.value = filN;
				x.add(option);
			}
		  
		}

		//chart.update(trdData)

  }
};
function updateProgress(evt) 
{
   if (evt.lengthComputable) 
   {  // evt.loaded the bytes the browser received
      // evt.total the total bytes set by the header
      // jQuery UI progress bar to show the progress on screen
     var percentComplete = (evt.loaded / evt.total) * 100;  
	 var elem = document.getElementById("brxBar");
     elem.style.width = percentComplete + "%"
   } 
}
var n = new Date()
var responsiveOptions = [
  ['screen and (min-width:701px) and (max-width: 1900px)', {

    
    axisX: {
      labelInterpolationFnc: function(value) {
        // Will return Mon, Tue, Wed etc. on medium screens
        return moment(value).format('MMM D yyyy hh:mm:ss');
      }
    }
  }],
  ['screen and (max-width: 700px)', {
	
    showPoint: false,
    axisX: {
      labelInterpolationFnc: function(value) {
        // Will return M, T, W etc. on small screens
        return moment(value).format('mm:ss');
      }
    }
  }]
];

var msSinceEpoch = n.getTime() 
var trdData = JSON.parse('{"series": []}')

//trdData["series"].push(data)
var chart = new Chartist.Line('.ct-chart', trdData, {
  axisX: {
    type: Chartist.FixedScaleAxis,
	divisor: 6,
    labelInterpolationFnc: function(value) {
      return moment(value).format('MMM D yyyy hh:mm:ss');
    }
  },axisY: {
    type: Chartist.AutoScaleAxis
  },
  plugins: [
    Chartist.plugins.zoom({ onZoom: onZoom })
  ],fullWidth: true,
  chartPadding: {
    right: 20
  }
},responsiveOptions);

var resetFnc;
function onZoom(chart, reset) {
  resetFnc = reset;
}

var btn = document.getElementById("resetZ");
btn.id = 'reset-zoom-btn';
btn.innerHTML = 'Reset Zoom';
btn.style.float = 'right';
btn.addEventListener('click', function() {
  console.log(resetFnc);
  resetFnc && resetFnc();
});


</script>

</body>
</html>
